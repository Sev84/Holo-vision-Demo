<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HOLO-VISION | Proje Paneli</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/@phosphor-icons/web"></script>
    <!-- QR Kod Okuyucu Kütüphanesi -->
    <script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.min.js"></script>
    <!-- Leaflet Harita Kütüphanesi -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>

    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-image: linear-gradient(rgba(17, 24, 39, 0.95), rgba(17, 24, 39, 0.98)), url('https://images.unsplash.com/photo-1519751138087-5bf79df62d5b?q=80&w=2070&auto=format&fit=crop');
            background-size: cover;
            background-position: center;
            background-attachment: fixed;
            color: #F3F4F6;
        }
        .card-hover-effect {
            transition: transform 0.3s ease-in-out, box-shadow 0.3s ease-in-out;
        }
        .card-hover-effect:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.25);
        }
        .info-card {
            background-color: rgba(31, 41, 55, 0.8);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        #welcome-modal {
            background-color: rgba(0,0,0,0.8);
            backdrop-filter: blur(5px);
        }
        .high-contrast {
            background-image: none !important;
            background-color: #000 !important;
            color: #FFFF00 !important;
        }
        .high-contrast .info-card, .high-contrast .bg-gray-800\/80 {
            background-color: #000 !important;
            border: 1px solid #FFFF00;
        }
        .high-contrast h1, .high-contrast h2, .high-contrast h3, .high-contrast p, .high-contrast button {
            color: #FFFF00 !important;
        }
         .high-contrast [class*="text-gray-"] {
            color: #FFFF00 !important;
        }
        /* Canlı İstatistik Paneli Stilleri */
        #live-stats {
            transition: opacity 0.5s ease-in-out;
        }
        #live-stats ul li {
            animation: fadeIn 0.5s ease-in-out;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        /* Gemini AI Yükleme Animasyonu */
        .loader {
            width: 48px;
            height: 48px;
            border: 5px solid #FFF;
            border-bottom-color: #FF3D00;
            border-radius: 50%;
            display: inline-block;
            box-sizing: border-box;
            animation: rotation 1s linear infinite;
        }
        @keyframes rotation {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="antialiased">

    <!-- Sesli Yönerge Modalı -->
    <div id="welcome-modal" class="fixed inset-0 z-50 flex items-center justify-center transition-opacity duration-300">
        <div class="bg-gray-800 rounded-2xl p-8 text-center shadow-2xl max-w-sm mx-4 transform transition-all duration-300 scale-95 opacity-0" id="modal-content">
            <img src="logo111111.png" alt="HOLO-VISION Logosu" class="h-20 w-auto mx-auto mb-4" onerror="this.onerror=null;this.src='https://placehold.co/200x100/374151/FFFFFF?text=Logo';">
            <h2 class="text-2xl font-bold text-white mb-2">Uygulamaya Hoş Geldiniz</h2>
            <p class="text-gray-400 mb-6">Başlamak için sesli yönergeyi dinleyebilir veya kapatabilirsiniz.</p>
            <div class="flex justify-center gap-4">
                 <button id="play-guide-btn" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-6 rounded-lg transition-transform duration-200 hover:scale-105" aria-label="Sesli Yönergeyi Oynat">
                    <i class="ph-bold ph-play-circle"></i> Yönergeyi Oynat
                </button>
                <button id="skip-modal-btn" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-6 rounded-lg transition-transform duration-200 hover:scale-105" aria-label="Sesli yönergeyi kapat">Kapat</button>
            </div>
        </div>
    </div>
    <audio id="voice-instruction" src="https://sev84.github.io/Holo-vision-Demo/sesli%20yonerge.mp3" preload="auto"></audio>

    <!-- Erişilebilirlik Butonu -->
    <button id="accessibility-btn" class="fixed top-4 right-4 z-50 bg-gray-800/50 backdrop-blur-sm p-3 rounded-full text-white hover:bg-gray-700/70 transition-colors" aria-label="Yüksek Kontrast Modunu Aç/Kapat">
        <i class="ph-bold ph-eye text-2xl"></i>
    </button>

    <!-- Canlı İstatistik Paneli -->
    <div id="live-stats" class="fixed bottom-4 right-4 z-50 bg-gray-900/70 backdrop-blur-md p-4 rounded-xl shadow-lg max-w-xs w-full opacity-0">
        <div class="flex items-center justify-between mb-3">
            <h3 class="text-lg font-bold text-white flex items-center"><i class="ph-fill ph-radio-tower text-green-400 mr-2"></i> Canlı Veri</h3>
            <p class="text-sm text-gray-300"><span id="online-users-count">0</span> Çevrimiçi</p>
        </div>
        <ul id="live-events" class="text-sm space-y-2 text-gray-300 h-24 overflow-y-hidden">
            <!-- Canlı olaylar buraya eklenecek -->
        </ul>
    </div>


    <div class="container mx-auto p-4 md:p-8">

        <header id="hero-section" class="text-center py-16">
            <div class="flex justify-center mb-8">
                <img src="logo111111.png" alt="HOLO-VISION Logosu" class="h-28 w-auto" onerror="this.onerror=null;this.src='https://placehold.co/200x100/111827/FFFFFF?text=Logo';">
            </div>
            <h1 class="text-5xl md:text-6xl font-extrabold text-white mb-4">HOLO-VISION</h1>
            <p class="text-xl text-gray-300 max-w-3xl mx-auto">Engelsiz kentler için teknolojiyi adımlarınıza taşıyoruz.</p>
            
            <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6 mt-12 max-w-6xl mx-auto">
                <div class="info-card rounded-xl p-6 text-center card-hover-effect"><i class="ph-bold ph-person-simple-walk text-5xl text-red-500 mx-auto mb-4"></i><h3 class="text-lg font-bold text-white">Problem</h3><p class="text-sm text-gray-400 mt-1">Kentlerdeki fiziksel engeller ve yönlendirme eksikliği.</p></div>
                <div class="info-card rounded-xl p-6 text-center card-hover-effect"><i class="ph-bold ph-cpu text-5xl text-blue-500 mx-auto mb-4"></i><h3 class="text-lg font-bold text-white">Teknoloji</h3><p class="text-sm text-gray-400 mt-1">Ultrasonik ve renk sensörleri ile donatılmış akıllı sistem.</p></div>
                <div class="info-card rounded-xl p-6 text-center card-hover-effect"><i class="ph-bold ph-shoe text-5xl text-green-500 mx-auto mb-4"></i><h3 class="text-lg font-bold text-white">Çözüm</h3><p class="text-sm text-gray-400 mt-1">Titreşim ve sesli uyarılar üreten giyilebilir akıllı ayakkabı.</p></div>
                <div class="info-card rounded-xl p-6 text-center card-hover-effect"><i class="ph-bold ph-shield-check text-5xl text-yellow-500 mx-auto mb-4"></i><h3 class="text-lg font-bold text-white">Etki</h3><p class="text-sm text-gray-400 mt-1">Güvenli, bağımsız hareket ve artan toplumsal katılım.</p></div>
            </div>
            
            <div class="mt-16">
                 <div class="bg-gray-800/50 backdrop-blur-sm rounded-xl p-3 sm:p-4 shadow-lg max-w-md mx-auto border border-white/10">
                    <img src="afis gorsel111.png" alt="Engelsiz Kentler Proje Afişi" class="rounded-lg w-full" onerror="this.onerror=null;this.src='https://placehold.co/600x800/1f2937/FFFFFF?text=Afiş+Yüklenemedi';">
                </div>
            </div>
        </header>

        <main class="space-y-16">
            
            <section id="stats-section" aria-labelledby="stats-heading">
                <h2 id="stats-heading" class="text-3xl font-bold mb-8 border-l-4 border-red-500 pl-4">Canlı İstatistik Paneli</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                    <div class="info-card rounded-xl p-6 flex items-center gap-4"><i class="ph-bold ph-qr-code text-4xl text-green-400"></i><div><p class="text-sm text-gray-400">Toplam Tarama</p><p class="text-3xl font-bold text-white" id="total-scans">0</p></div></div>
                    <div class="info-card rounded-xl p-6 flex items-center gap-4"><i class="ph-bold ph-users text-4xl text-indigo-400"></i><div><p class="text-sm text-gray-400">Toplam Ziyaretçi</p><p class="text-3xl font-bold text-white" id="total-visitors">0</p></div></div>
                    <div class="info-card rounded-xl p-6 flex items-center gap-4"><i class="ph-bold ph-map-pin text-4xl text-red-400"></i><div><p class="text-sm text-gray-400">Tespit Edilen Konum</p><p class="text-xl font-bold text-white" id="location-info">İzin bekleniyor...</p></div></div>
                    <div class="info-card rounded-xl p-6 flex items-center gap-4"><i class="ph-bold ph-trophy text-4xl text-yellow-400"></i><div><p class="text-sm text-gray-400">En Popüler Kod</p><p class="text-2xl font-bold text-white">Park Alanı</p></div></div>
                </div>
                 <div class="info-card rounded-xl p-6 mt-6">
                    <h3 class="text-lg font-semibold mb-4">Haftalık Tarama Trendi</h3>
                    <div id="bar-chart" class="flex items-end justify-between h-40"></div>
                     <p class="text-xs text-gray-500 mt-2 text-right">Son Güncelleme: <span id="last-updated"></span></p>
                </div>
            </section>

            <section id="camera-color-picker-section" aria-labelledby="camera-heading">
                <h2 id="camera-heading" class="text-3xl font-bold mb-8 border-l-4 border-red-500 pl-4">Canlı Renk Tanıma</h2>
                <div class="info-card rounded-xl p-6">
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 items-center">
                        <div class="relative w-full max-w-md mx-auto aspect-video bg-gray-900 rounded-lg overflow-hidden border border-gray-700">
                            <video id="camera-feed" class="w-full h-full object-cover" autoplay playsinline></video>
                            <div id="crosshair" class="absolute top-1/2 left-1/2 w-6 h-6 -translate-x-1/2 -translate-y-1/2 border-2 border-red-500 rounded-full pointer-events-none" style="display: none;"></div>
                            <canvas id="snapshot-canvas" class="hidden"></canvas>
                        </div>
                        <div>
                            <div class="flex flex-row items-start justify-center gap-4 sm:gap-8 mb-6">
                                <div class="text-center flex-1">
                                    <p class="text-gray-400 mb-2">Algılanan Renk</p>
                                    <div id="color-preview" class="w-20 h-20 sm:w-24 sm:h-24 rounded-full border-4 border-gray-600 shadow-lg transition-colors duration-200 mx-auto" style="background-color: #000;"></div>
                                    <p id="color-value" class="text-lg sm:text-xl font-bold text-white font-mono tracking-widest mt-2">#000000</p>
                                </div>
                                <div class="text-center flex-1">
                                    <p class="text-gray-400 mb-2">Eşleşen Alan</p>
                                    <div id="matched-color-preview" class="w-20 h-20 sm:w-24 sm:h-24 rounded-full border-4 border-gray-600 shadow-lg transition-colors duration-200 mx-auto flex items-center justify-center" style="background-color: #000;">
                                        <i id="matched-color-icon" class="ph text-3xl sm:text-4xl text-white"></i>
                                    </div>
                                    <p id="matched-color-name" class="text-lg sm:text-xl font-bold text-white mt-2">-</p>
                                    <p id="matched-color-percentage" class="text-sm text-blue-300 mt-1"></p>
                                </div>
                            </div>
                            <div class="flex justify-center">
                                <button id="start-camera-btn" class="bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-8 rounded-lg transition-transform duration-200 hover:scale-105">
                                    Kamerayı Başlat
                                </button>
                            </div>
                        </div>
                    </div>
                    <p id="camera-error" class="text-red-500 text-center mt-4 hidden"></p>
                </div>
            </section>

            <section id="map-section" aria-labelledby="map-heading">
                <h2 id="map-heading" class="text-3xl font-bold mb-8 border-l-4 border-red-500 pl-4">İşlev Alanları Haritası</h2>
                <div class="info-card rounded-xl p-2 shadow-lg h-96 mb-4">
                    <div id="leaflet-map" class="w-full h-full rounded-xl"></div>
                </div>
                <div class="info-card rounded-xl p-6">
                    <div class="flex justify-between items-center mb-4">
                         <h3 class="text-xl font-bold text-white">Yapay Zeka Destekli Çevre Analizi</h3>
                         <button id="speak-analysis-btn" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg flex items-center gap-2" disabled>
                            <i class="ph-bold ph-speaker-high"></i> Analizi Seslendir
                        </button>
                    </div>
                    <div id="gemini-analysis-container">
                        <div id="gemini-loading" class="text-center py-4 hidden">
                            <div class="loader mx-auto"></div>
                            <p class="mt-2 text-gray-400">Yapay zeka çevrenizi analiz ediyor...</p>
                        </div>
                        <div id="gemini-result" class="text-gray-300">
                            Konum izni bekleniyor...
                        </div>
                    </div>
                </div>
            </section>

            <section id="functions-section" aria-labelledby="functions-heading">
                <h2 id="functions-heading" class="text-3xl font-bold mb-8 border-l-4 border-red-500 pl-4">Proje İşlevleri ve Sesli Bilgilendirme</h2>
                <div id="islevKonteyneri" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6"></div>
            </section>

            <section id="dynamic-qr-section" aria-labelledby="qr-heading">
                <h2 id="qr-heading" class="text-3xl font-bold mb-8 border-l-4 border-red-500 pl-4">Dinamik QR Kod Yönetimi</h2>
                <div class="info-card rounded-xl p-6">
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 items-center">
                        <div class="relative w-full max-w-md mx-auto aspect-square bg-gray-900 rounded-lg overflow-hidden border border-gray-700">
                            <video id="qr-camera-feed" class="w-full h-full object-cover" autoplay playsinline></video>
                             <div id="qr-line" class="absolute top-1/2 left-0 w-full h-1 bg-red-500/50 shadow-lg" style="display: none;"></div>
                            <canvas id="qr-snapshot-canvas" class="hidden"></canvas>
                        </div>
                        <div class="text-center">
                            <h3 class="text-2xl font-bold mb-4">QR Kodu Tara veya Yükle</h3>
                            <div class="flex justify-center gap-4 mb-4">
                                <button id="start-qr-camera-btn" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg">Kamerayı Aç</button>
                                <label for="qr-file-input" class="bg-purple-600 hover:bg-purple-700 text-white font-bold py-2 px-4 rounded-lg cursor-pointer">Dosya Yükle</label>
                                <input type="file" id="qr-file-input" class="hidden" accept="image/*">
                            </div>
                            <div class="mt-4 p-4 bg-gray-900/50 rounded-lg min-h-[6rem]">
                                <p class="text-gray-400">Okunan Veri:</p>
                                <p id="qr-result" class="text-lg text-green-400 font-mono break-all">-</p>
                                <button id="open-qr-link-btn" class="hidden mt-2 bg-green-600 hover:bg-green-700 text-white font-bold py-1 px-3 rounded-lg">Linki Aç</button>
                            </div>
                            <p id="qr-camera-error" class="text-red-500 text-center mt-2 hidden"></p>
                        </div>
                    </div>
                </div>
            </section>

            <section id="qrcards-section" aria-labelledby="qrcards-heading">
                <h2 id="qrcards-heading" class="text-3xl font-bold mb-8 border-l-4 border-red-500 pl-4">QR Kod Kart Tasarımları</h2>
                <div class="bg-gray-800/80 backdrop-blur-sm rounded-xl p-3 sm:p-4 shadow-lg border border-white/10">
                    <img src="KARTLAR.png" alt="QR Kod Kart Tasarımları" class="rounded-lg w-full" onerror="this.onerror=null;this.src='https://placehold.co/1200x600/1f2937/FFFFFF?text=Tasarım+Görseli+Yüklenemedi';">
                </div>
            </section>

            <section id="yonerge-section" aria-labelledby="yonerge-heading">
                <h2 id="yonerge-heading" class="text-3xl font-bold mb-8 border-l-4 border-red-500 pl-4">Proje Yönergesi ve Kart Detayı</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                    <div class="bg-gray-800/80 backdrop-blur-sm rounded-xl p-3 sm:p-4 shadow-lg border border-white/10">
                        <h3 class="text-xl font-semibold text-white mb-4 text-center">Genel İşleyiş</h3>
                        <img src="YONERGE.png" alt="Proje Genel İşleyişi" class="rounded-lg w-full" onerror="this.onerror=null;this.src='https://placehold.co/600x800/1f2937/FFFFFF?text=Yönerge+Yüklenemedi';">
                    </div>
                    <div class="bg-gray-800/80 backdrop-blur-sm rounded-xl p-3 sm:p-4 shadow-lg border border-white/10">
                        <h3 class="text-xl font-semibold text-white mb-4 text-center">Örnek Kart Açıklaması</h3>
                        <img src="KART YONERGE.png" alt="Örnek QR Kod Kartı Açıklaması" class="rounded-lg w-full" onerror="this.onerror=null;this.src='https://placehold.co/600x800/1f2937/FFFFFF?text=Kart+Detayı+Yüklenemedi';">
                    </div>
                </div>
            </section>
            
            <!-- YENİ: API Anahtar Yönetimi -->
            <section id="api-keys-section" aria-labelledby="api-keys-heading">
                <h2 id="api-keys-heading" class="text-3xl font-bold mb-8 border-l-4 border-red-500 pl-4">API Anahtar Yönetimi</h2>
                <div class="info-card rounded-xl p-6 space-y-4">
                    <div>
                        <label for="gemini-api-key" class="block mb-2 text-sm font-medium text-gray-300">Gemini API Anahtarı</label>
                        <input type="password" id="gemini-api-key" class="bg-gray-700 border border-gray-600 text-white text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5" value="AIzaSyDXB2Q128hS1frOviNxOuzd8tEQ2lV6PSY">
                    </div>
                    <div>
                        <label for="elevenlabs-api-key" class="block mb-2 text-sm font-medium text-gray-300">ElevenLabs API Anahtarı</label>
                        <input type="password" id="elevenlabs-api-key" class="bg-gray-700 border border-gray-600 text-white text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5" value="sk_89f86145095cc4c407772084e105cb1f03541d229ac6606e">
                    </div>
                    <div class="flex items-center gap-4">
                        <button id="save-api-keys-btn" class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-5 rounded-lg">Kaydet</button>
                        <p id="api-status-msg" class="text-green-400 text-sm"></p>
                    </div>
                </div>
            </section>
        </main>

        <footer class="text-center mt-20 text-gray-500 text-sm">
            <p>&copy; 2025 HOLO-VISION Takımı. Tüm hakları saklıdır.</p>
        </footer>
    </div>

    <script>
        const islevKartlari = [
            { id: 1, islevAdi: "Otobüs Durağı", aciklama: "Güvenli rota kartı...", gorselURL: "DURAK.png", sesURL: "https://sev84.github.io/Holo-vision-Demo/Otob%C3%BCs%20Dura%C4%9F%C4%B1.mp3", icon: "ph-bus" },
            { id: 2, islevAdi: "Hastane Alanı", aciklama: "Güvenli rota kartı...", gorselURL: "HASTANE.png", sesURL: "https://sev84.github.io/Holo-vision-Demo/Hastane%20Alan%C4%B1.mp3", icon: "ph-first-aid-kit" },
            { id: 3, islevAdi: "Okul Alanı", aciklama: "Güvenli rota kartı...", gorselURL: "OKUL.png", sesURL: "https://sev84.github.io/Holo-vision-Demo/Okul%20Alan%C4%B1.mp3", icon: "ph-student" },
            { id: 4, islevAdi: "Park Alanı", aciklama: "Güvenli rota kartı...", gorselURL: "PARK.png", sesURL: "https://sev84.github.io/Holo-vision-Demo/Park%20Alan%C4%B1.mp3", icon: "ph-tree" },
            { id: 5, islevAdi: "Ticari Alan", aciklama: "Güvenli rota kartı...", gorselURL: "TİCARİ.png", sesURL: "https://sev84.github.io/Holo-vision-Demo/Ticari%20Alan.mp3", icon: "ph-shopping-cart-simple" }
        ];

        const renkEslesmeleri = [
            { name: "Okul Alanı", hex: "#FFA500", r: 255, g: 165, b: 0, icon: "ph-student", sesURL: "https://sev84.github.io/Holo-vision-Demo/Okul%20Alan%C4%B1.mp3" },
            { name: "Park Alanı", hex: "#800080", r: 128, g: 0, b: 128, icon: "ph-tree", sesURL: "https://sev84.github.io/Holo-vision-Demo/Park%20Alan%C4%B1.mp3" },
            { name: "Hastane Alanı", hex: "#40E0D0", r: 64, g: 224, b: 208, icon: "ph-first-aid-kit", sesURL: "https://sev84.github.io/Holo-vision-Demo/Hastane%20Alan%C4%B1.mp3" },
            { name: "Ticari Alan", hex: "#FFFF00", r: 255, g: 255, b: 0, icon: "ph-shopping-cart-simple", sesURL: "https://sev84.github.io/Holo-vision-Demo/Ticari%20Alan.mp3" },
            { name: "Otobüs Durağı", hex: "#008000", r: 0, g: 128, b: 0, icon: "ph-bus", sesURL: "https://sev84.github.io/Holo-vision-Demo/Otob%C3%BCs%20Dura%C4%9F%C4%B1.mp3" }
        ];
        
        // Global API anahtar değişkenleri
        let GEMINI_API_KEY = "";
        let ELEVENLABS_API_KEY = "";

        document.addEventListener('DOMContentLoaded', () => {
            initApiManagement();
            initWelcomeModal();
            initAccessibility();
            kartlariOlustur();
            initCameraColorPicker(); 
            initQrScanner();
            initStatsDashboard();
            initLiveStats();
        });

        function initApiManagement() {
            const geminiInput = document.getElementById('gemini-api-key');
            const elevenlabsInput = document.getElementById('elevenlabs-api-key');
            const saveBtn = document.getElementById('save-api-keys-btn');
            const statusMsg = document.getElementById('api-status-msg');

            GEMINI_API_KEY = geminiInput.value;
            ELEVENLABS_API_KEY = elevenlabsInput.value;

            saveBtn.addEventListener('click', () => {
                GEMINI_API_KEY = geminiInput.value;
                ELEVENLABS_API_KEY = elevenlabsInput.value;
                statusMsg.textContent = 'API anahtarları başarıyla güncellendi!';
                setTimeout(() => {
                    statusMsg.textContent = '';
                }, 3000);
            });
        }

        function initWelcomeModal() {
            const welcomeModal = document.getElementById('welcome-modal');
            const modalContent = document.getElementById('modal-content');
            const skipBtn = document.getElementById('skip-modal-btn');
            const playBtn = document.getElementById('play-guide-btn');
            const instructionAudio = document.getElementById('voice-instruction');

            if (!welcomeModal || !modalContent || !skipBtn || !playBtn || !instructionAudio) return;

            setTimeout(() => {
                welcomeModal.classList.add('opacity-100');
                modalContent.classList.remove('scale-95', 'opacity-0');
                modalContent.classList.add('scale-100', 'opacity-100');
            }, 500);

            const closeModal = () => {
                if (instructionAudio.duration > 0 && !instructionAudio.paused) {
                    instructionAudio.pause();
                    instructionAudio.currentTime = 0;
                }
                modalContent.classList.add('scale-95', 'opacity-0');
                setTimeout(() => {
                    welcomeModal.classList.add('opacity-0');
                    setTimeout(() => welcomeModal.style.display = 'none', 300);
                }, 300);
            };
            
            playBtn.addEventListener('click', () => {
                if (instructionAudio.paused) {
                    instructionAudio.play().catch(e => console.error("Yönerge sesi oynatılamadı:", e));
                } else {
                    instructionAudio.pause();
                    instructionAudio.currentTime = 0;
                }
            });

            skipBtn.addEventListener('click', closeModal);
        }

        function initAccessibility() {
            const accessibilityBtn = document.getElementById('accessibility-btn');
            accessibilityBtn.addEventListener('click', () => {
                document.body.classList.toggle('high-contrast');
            });
        }

        function initStatsDashboard() {
            const totalScansEl = document.getElementById('total-scans');
            const totalVisitorsEl = document.getElementById('total-visitors');
            const lastUpdatedEl = document.getElementById('last-updated');
            const locationInfoEl = document.getElementById('location-info');
            const speakAnalysisBtn = document.getElementById('speak-analysis-btn');
            const geminiLoading = document.getElementById('gemini-loading');
            const geminiResult = document.getElementById('gemini-result');
            let map;
            let lastKnownPosition = null;

            let scanCount = 1482;
            let visitorCount = 312;

            totalScansEl.textContent = scanCount;
            totalVisitorsEl.textContent = visitorCount;
            lastUpdatedEl.textContent = new Date().toLocaleTimeString('tr-TR');
            
            // Haritayı varsayılan konumla başlat
            map = L.map('leaflet-map').setView([41.0082, 28.9784], 10); // İstanbul
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a>'
            }).addTo(map);

            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(async position => {
                    const { latitude, longitude } = position.coords;

                    if (lastKnownPosition && lastKnownPosition.lat === latitude && lastKnownPosition.lon === longitude) {
                        return;
                    }
                    lastKnownPosition = { lat: latitude, lon: longitude };
                    
                    map.setView([latitude, longitude], 16);
                    L.marker([latitude, longitude]).addTo(map).bindPopup('Buradasınız.').openPopup();

                    const response = await fetch(`https://api.bigdatacloud.net/data/reverse-geocode-client?latitude=${latitude}&longitude=${longitude}&localityLanguage=tr`);
                    const data = await response.json();
                    const locationText = `${data.locality}, ${data.city}, ${data.principalSubdivision}`;
                    locationInfoEl.textContent = locationText;

                    speak(`Konumunuz bulundu: ${locationText}`);
                    
                    geminiLoading.classList.remove('hidden');
                    geminiResult.textContent = '';
                    const analysisText = await getGeminiAnalysis(latitude, longitude);

                    if(analysisText) {
                        speakAnalysisBtn.disabled = false;
                        speakAnalysisBtn.onclick = () => speak(analysisText);
                    }

                }, () => {
                    locationInfoEl.textContent = "İzin verilmedi";
                    geminiResult.textContent = "Konum analizi için coğrafi konum izni gereklidir.";
                });
            } else {
                locationInfoEl.textContent = "Desteklenmiyor";
                geminiResult.textContent = "Tarayıcınız coğrafi konumu desteklemiyor.";
            }

            const chart = document.getElementById('bar-chart');
            if(chart) {
                const days = ['Pzt', 'Sal', 'Çar', 'Per', 'Cum', 'Cmt', 'Paz'];
                const data = [30, 50, 75, 60, 90, 110, 85];
                chart.innerHTML = ''; 
                days.forEach((day, index) => {
                    const height = (data[index] / 120) * 100;
                    const barWrapper = document.createElement('div');
                    barWrapper.className = 'flex-1 flex flex-col items-center justify-end h-full';
                    barWrapper.innerHTML = `
                        <div class="w-3/4 bg-blue-500 rounded-t-lg transition-all duration-1000" style="height: 0%;" title="${data[index]} tarama"></div>
                        <p class="text-xs text-gray-400 mt-2">${day}</p>
                    `;
                    chart.appendChild(barWrapper);

                    setTimeout(() => {
                        barWrapper.querySelector('div').style.height = `${height}%`;
                    }, 200 * (index + 1));
                });
            }
        }
        
        async function getGeminiAnalysis(lat, lon) {
            const geminiLoading = document.getElementById('gemini-loading');
            const geminiResult = document.getElementById('gemini-result');
            const prompt = `${lat},${lon} koordinatlarının 500 metrelik yarıçapı içindeki işlevsel alanlar (parklar, hastaneler, okullar, otobüs durakları, ticari alanlar gibi) hakkında bir analiz yap. Bu alandaki bu tür yerlerin genel bir özetini ve tahmini sayısını ver. Cevabını kısa ve net bir şekilde Türkçe olarak sun.`;
            
            try {
                let chatHistory = [{ role: "user", parts: [{ text: prompt }] }];
                const payload = { contents: chatHistory };
                const apiKey = GEMINI_API_KEY || ""; 
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;
                
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) {
                    const errorBody = await response.json();
                    console.error("API Error Body:", errorBody);
                    throw new Error(`API hatası: ${response.status}. ${errorBody.error?.message || ''}`);
                }

                const result = await response.json();
                
                if (result.candidates && result.candidates.length > 0 &&
                    result.candidates[0].content && result.candidates[0].content.parts &&
                    result.candidates[0].content.parts.length > 0) {
                    const text = result.candidates[0].content.parts[0].text;
                    geminiResult.innerHTML = text.replace(/\n/g, '<br>');
                    return text;
                } else {
                    geminiResult.textContent = "Analiz sonucu alınamadı, lütfen API anahtarınızı kontrol edin.";
                }

            } catch (error) {
                console.error("Gemini analizi hatası:", error);
                geminiResult.textContent = `Çevre analizi yapılırken bir hata oluştu: ${error.message}`;
            } finally {
                geminiLoading.classList.add('hidden');
            }
            return null;
        }

        async function speak(text) {
            if ('speechSynthesis' in window) {
                window.speechSynthesis.cancel();
            }
            if (ELEVENLABS_API_KEY) {
                const voiceId = '21m00Tcm4TlvDq8ikWAM';
                const url = `https://api.elevenlabs.io/v1/text-to-speech/${voiceId}`;
                const headers = { 'Accept': 'audio/mpeg', 'Content-Type': 'application/json', 'xi-api-key': ELEVENLABS_API_KEY };
                const data = { text: text, model_id: 'eleven_multilingual_v2', voice_settings: { stability: 0.5, similarity_boost: 0.75 } };

                try {
                    const response = await fetch(url, { method: 'POST', headers: headers, body: JSON.stringify(data) });
                    if (!response.ok) { throw new Error(`ElevenLabs API hatası: ${response.status}`); }
                    const audioBlob = await response.blob();
                    const audioUrl = URL.createObjectURL(audioBlob);
                    const audio = new Audio(audioUrl);
                    audio.play();
                } catch (error) {
                    console.error("ElevenLabs API hatası, tarayıcı sesine geçiliyor:", error);
                    speakWithBrowser(text);
                }
            } else {
                speakWithBrowser(text);
            }
        }

        function speakWithBrowser(text) {
            if ('speechSynthesis' in window) {
                const utterance = new SpeechSynthesisUtterance(text);
                utterance.lang = 'tr-TR';
                window.speechSynthesis.speak(utterance);
            } else {
                console.log("Tarayıcınız ses sentezini desteklemiyor.");
            }
        }

        function kartlariOlustur() {
            const konteyner = document.getElementById('islevKonteyneri');
            if (!konteyner) return;
            konteyner.innerHTML = ''; 
            const audioPlayer = new Audio();
            let leaveTimeout;

            islevKartlari.forEach(kart => {
                const islevKarti = document.createElement('div');
                islevKarti.className = 'info-card rounded-xl overflow-hidden shadow-lg flex flex-col card-hover-effect';
                islevKarti.innerHTML = `
                    <div class="relative">
                        <img src="${kart.gorselURL}" alt="${kart.islevAdi} için kart görseli" class="w-full h-52 object-contain p-4 bg-gray-900/50" onerror="this.onerror=null;this.src='https://placehold.co/400x208/1f2937/FFFFFF?text=Görsel+Yok';">
                        <div class="absolute top-3 right-3 bg-black bg-opacity-50 p-2 rounded-full">
                            <i class="ph-bold ${kart.icon} text-2xl text-white"></i>
                        </div>
                    </div>
                    <div class="p-5 flex flex-col flex-grow">
                        <h3 class="text-xl font-semibold text-white mb-2">${kart.islevAdi}</h3>
                        <p class="text-gray-400 text-sm mb-4 flex-grow">${kart.aciklama}</p>
                    </div>
                `;
                
                islevKarti.addEventListener('mouseenter', () => {
                    clearTimeout(leaveTimeout);
                    if (audioPlayer.src !== kart.sesURL) {
                        audioPlayer.src = kart.sesURL;
                    }
                    if (audioPlayer.paused) {
                       audioPlayer.play().catch(e => {
                           if (e.name !== 'AbortError') console.error("Kart sesi çalınamadı:", e);
                       });
                    }
                });

                islevKarti.addEventListener('mouseleave', () => {
                    leaveTimeout = setTimeout(() => {
                        audioPlayer.pause();
                        audioPlayer.currentTime = 0;
                    }, 50);
                });

                konteyner.appendChild(islevKarti);
            });
        }

        function initCameraColorPicker() {
            const video = document.getElementById('camera-feed');
            const canvas = document.getElementById('snapshot-canvas');
            const colorPreview = document.getElementById('color-preview');
            const colorValue = document.getElementById('color-value');
            const matchedColorPreview = document.getElementById('matched-color-preview');
            const matchedColorName = document.getElementById('matched-color-name');
            const matchedColorIcon = document.getElementById('matched-color-icon');
            const matchedColorPercentage = document.getElementById('matched-color-percentage');
            const startBtn = document.getElementById('start-camera-btn');
            const errorMsg = document.getElementById('camera-error');
            const crosshair = document.getElementById('crosshair');

            let intervalId = null;
            let stream = null;
            let lastMatchedColorName = null;
            let matchAudio = new Audio();

            const findClosestColor = (r, g, b) => {
                let closestMatch = { color: null, distance: Infinity };
                for (const color of renkEslesmeleri) {
                    const distance = Math.sqrt(Math.pow(r - color.r, 2) + Math.pow(g - color.g, 2) + Math.pow(b - color.b, 2));
                    if (distance < closestMatch.distance) {
                        closestMatch.distance = distance;
                        closestMatch.color = color;
                    }
                }
                const threshold = 180; 
                return closestMatch.distance < threshold ? closestMatch : { color: null, distance: Infinity };
            };

            const processFrame = () => {
                if (!video.srcObject || video.paused || video.ended || !stream || !stream.active) return;
                const context = canvas.getContext('2d', { willReadFrequently: true });
                canvas.width = video.videoWidth; canvas.height = video.videoHeight;
                context.drawImage(video, 0, 0, canvas.width, canvas.height);
                const centerX = Math.floor(canvas.width / 2), centerY = Math.floor(canvas.height / 2);
                const sampleSize = 10;
                const imageData = context.getImageData(centerX - (sampleSize/2), centerY - (sampleSize/2), sampleSize, sampleSize).data;
                let r_avg = 0, g_avg = 0, b_avg = 0;
                for (let i = 0; i < imageData.length; i += 4) { r_avg += imageData[i]; g_avg += imageData[i+1]; b_avg += imageData[i+2]; }
                const pixelCount = imageData.length / 4;
                const r = Math.floor(r_avg / pixelCount), g = Math.floor(g_avg / pixelCount), b = Math.floor(b_avg / pixelCount);
                const toHex = (c) => ('0' + c.toString(16)).slice(-2);
                const hexColor = `#${toHex(r)}${toHex(g)}${toHex(b)}`;
                colorPreview.style.backgroundColor = hexColor;
                colorValue.textContent = hexColor.toUpperCase();

                const { color: matchedColor, distance } = findClosestColor(r, g, b);
                if (matchedColor) {
                    const percentage = Math.round(Math.max(0, (1 - (distance / 180)) * 100));
                    matchedColorPreview.style.backgroundColor = matchedColor.hex;
                    matchedColorName.textContent = matchedColor.name;
                    matchedColorIcon.className = `ph ${matchedColor.icon} text-4xl text-black`;
                    matchedColorPercentage.textContent = `Benzerlik: %${percentage}`;
                    if (lastMatchedColorName !== matchedColor.name) {
                        lastMatchedColorName = matchedColor.name;
                        if (!matchAudio.paused) { matchAudio.pause(); matchAudio.currentTime = 0; }
                        matchAudio.src = matchedColor.sesURL;
                        matchAudio.play().catch(e => { if (e.name !== 'AbortError') console.error("Renk sesi oynatılamadı:", e); });
                    }
                } else {
                    matchedColorPreview.style.backgroundColor = '#000';
                    matchedColorName.textContent = '-';
                    matchedColorIcon.className = 'ph text-4xl text-white';
                    matchedColorPercentage.textContent = '';
                    lastMatchedColorName = null;
                }
            };

            const startCamera = async () => {
                try {
                    if (stream) { stream.getTracks().forEach(track => track.stop()); }
                    errorMsg.classList.add('hidden');
                    stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' } });
                    video.srcObject = stream;
                    video.onloadedmetadata = () => {
                        video.play();
                        startBtn.textContent = 'Kamerayı Durdur';
                        startBtn.classList.replace('bg-green-600', 'bg-red-600');
                        startBtn.classList.replace('hover:bg-green-700', 'hover:bg-red-700');
                        crosshair.style.display = 'block';
                        intervalId = setInterval(processFrame, 250);
                    };
                } catch (err) {
                    console.error("Kamera erişim hatası:", err);
                    errorMsg.textContent = 'Kamera başlatılamadı.';
                    errorMsg.classList.remove('hidden');
                    startBtn.textContent = 'Tekrar Dene';
                }
            };

            const stopCamera = () => {
                if (stream) { stream.getTracks().forEach(track => track.stop()); }
                if (intervalId) { clearInterval(intervalId); }
                video.srcObject = null; stream = null; intervalId = null;
                startBtn.textContent = 'Kamerayı Başlat';
                startBtn.classList.replace('bg-red-600', 'bg-green-600');
                startBtn.classList.replace('hover:bg-red-700', 'hover:bg-green-700');
                crosshair.style.display = 'none';
                colorPreview.style.backgroundColor = '#000';
                colorValue.textContent = '#000000';
                matchedColorPreview.style.backgroundColor = '#000';
                matchedColorName.textContent = '-';
                matchedColorIcon.className = 'ph text-4xl text-white';
                matchedColorPercentage.textContent = '';
                lastMatchedColorName = null;
                if (matchAudio) matchAudio.pause();
            };

            startBtn.addEventListener('click', () => {
                if (stream && stream.active) { stopCamera(); } else { startCamera(); }
            });
        }

        function initQrScanner() {
            const video = document.getElementById('qr-camera-feed');
            const canvas = document.getElementById('qr-snapshot-canvas');
            const resultEl = document.getElementById('qr-result');
            const startBtn = document.getElementById('start-qr-camera-btn');
            const fileInput = document.getElementById('qr-file-input');
            const errorMsg = document.getElementById('qr-camera-error');
            const line = document.getElementById('qr-line');
            const openLinkBtn = document.getElementById('open-qr-link-btn');
            let currentQrLink = '';
            let stream = null;
            let animationFrameId = null;

            function handleQrCode(code) {
                if (!code) {
                    resultEl.textContent = "QR Kod bulunamadı.";
                    openLinkBtn.classList.add('hidden');
                    currentQrLink = '';
                    return;
                }

                resultEl.textContent = code.data;
                try {
                    new URL(code.data); // URL olup olmadığını doğrula
                    currentQrLink = code.data;
                    openLinkBtn.classList.remove('hidden');
                } catch (_) {
                    currentQrLink = '';
                    openLinkBtn.classList.add('hidden');
                }
            }

            openLinkBtn.addEventListener('click', () => {
                if (currentQrLink) {
                    window.open(currentQrLink, '_blank');
                }
            });

            function tick() {
                if (video.readyState === video.HAVE_ENOUGH_DATA) {
                    canvas.height = video.videoHeight; canvas.width = video.videoWidth;
                    const ctx = canvas.getContext('2d');
                    ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
                    const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
                    const code = jsQR(imageData.data, imageData.width, imageData.height, { inversionAttempts: "dontInvert" });
                    if (code) { handleQrCode(code); stopCamera(); }
                }
                if (stream && stream.active) { animationFrameId = requestAnimationFrame(tick); }
            }
            
            async function startCamera() {
                try {
                    if (stream) { stream.getTracks().forEach(track => track.stop()); }
                    errorMsg.classList.add('hidden');
                    stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" } });
                    video.srcObject = stream;
                    line.style.display = 'block';
                    startBtn.textContent = "Kamerayı Kapat";
                    animationFrameId = requestAnimationFrame(tick);
                } catch(e) {
                    errorMsg.textContent = "Kamera başlatılamadı.";
                    errorMsg.classList.remove('hidden'); console.error(e);
                }
            }

            function stopCamera() {
                if (animationFrameId) cancelAnimationFrame(animationFrameId);
                if (stream) { stream.getTracks().forEach(track => track.stop()); }
                video.srcObject = null; stream = null;
                line.style.display = 'none';
                startBtn.textContent = "Kamerayı Aç";
            }

            startBtn.addEventListener('click', () => {
                if (stream && stream.active) { stopCamera(); } else { startCamera(); }
            });

            fileInput.addEventListener('change', e => {
                if (e.target.files.length === 0) return;
                const file = e.target.files[0];
                const reader = new FileReader();
                reader.onload = (event) => {
                    const img = new Image();
                    img.onload = () => {
                        const ctx = canvas.getContext('2d');
                        canvas.width = img.width; canvas.height = img.height;
                        ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                        const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
                        const code = jsQR(imageData.data, imageData.width, imageData.height);
                        handleQrCode(code);
                    };
                    img.src = event.target.result;
                };
                reader.readAsDataURL(file);
            });
        }

        function initLiveStats() {
            const statsPanel = document.getElementById('live-stats');
            const usersCountEl = document.getElementById('online-users-count');
            const eventsListEl = document.getElementById('live-events');
            if (!statsPanel || !usersCountEl || !eventsListEl) return;

            statsPanel.style.display = 'block';
            setTimeout(() => statsPanel.classList.remove('opacity-0'), 100);


            let userCount = Math.floor(Math.random() * (150 - 80 + 1)) + 80;
            let userCity = "Türkiye";
            const fallbackCities = ["İstanbul", "Ankara", "İzmir", "Bursa", "Antalya"];
            
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(position => {
                    const { latitude, longitude } = position.coords;
                    fetch(`https://api.bigdatacloud.net/data/reverse-geocode-client?latitude=${latitude}&longitude=${longitude}&localityLanguage=tr`)
                        .then(res => res.json()).then(data => { userCity = data.city || userCity; });
                });
            }

            setInterval(() => {
                userCount += Math.floor(Math.random() * 5) - 2;
                if (userCount < 50) userCount = 50;
                usersCountEl.textContent = userCount;

                const randomAction = renkEslesmeleri[Math.floor(Math.random() * renkEslesmeleri.length)];
                const location = userCity !== "Türkiye" ? userCity : fallbackCities[Math.floor(Math.random() * fallbackCities.length)];
                
                const newEvent = document.createElement('li');
                newEvent.className = "flex items-center";
                newEvent.innerHTML = `<i class="ph-fill ${randomAction.icon} mr-2" style="color:${randomAction.hex};"></i> Bir kullanıcı <strong>${location}</strong>'dan ${randomAction.name} rengini taradı.`;

                eventsListEl.prepend(newEvent);
                if (eventsListEl.children.length > 4) {
                    eventsListEl.lastChild.remove();
                }

            }, 4500);
        }

    </script>
</body>
</html>
